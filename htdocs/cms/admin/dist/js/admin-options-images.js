(()=>{"use strict";class t{constructor(t,e,i=null,a={},s=null,n="default"){this.key=t,this.label=e,this.value=i,this.options=a,this.type=null,this.onChange=s,this.group=n,this.description=this.options?.description||null}render(){const t=document.createElement("div");t.className="option-block";const e=this.renderDescriptionIcon();return e&&t.appendChild(e),t}renderDescriptionIcon(){if(!this.description)return null;const t=document.createElement("span");return t.className="option-help",t.textContent="?",t.dataset.tooltip=this.description,t}notifyChange(){if("function"!=typeof this.onChange)throw new Error("onChange is not assigned or is not a function");this.onChange(this)}}class e extends t{constructor(t,e,i=null,a={},s=null,n="default"){super(t,e,i,a,s,n),this.type="int",this._timeout=null,this._delay=this.options?.delay??2e3,this._placeholder=this.options?.placeholder??""}render(t){const e=super.render();e.classList.add("int");const i=document.createElement("label");i.textContent=this.label,e.appendChild(i);const a=document.createElement("input");a.type="number",a.step="1",a.value=this.value??"",this._placeholder&&(a.placeholder=this._placeholder),e.appendChild(a);const s=document.createElement("div");s.className="save-progress",e.appendChild(s),a.addEventListener("input",(t=>{this.value=parseInt(t.target.value),s.style.transition="none",s.style.width="0",this._timeout&&clearTimeout(this._timeout),requestAnimationFrame((()=>{s.style.transition=`width ${this._delay}ms linear`,s.style.width="100%"})),this._timeout=setTimeout((()=>{this.notifyChange(),s.style.transition="none",s.style.width="0"}),this._delay)})),t.appendChild(e)}}class i extends t{constructor(t,e,i=null,a={},s=null,n="default"){super(t,e,i,a,s,n),this.type="float",this._timeout=null,this._delay=this.options?.delay??2e3,this._placeholder=this.options?.placeholder??""}render(t){const e=super.render();e.classList.add("float");const i=document.createElement("label");i.textContent=this.label,e.appendChild(i);const a=document.createElement("input");a.type="number",a.step="any",a.placeholder=this._placeholder,a.value=this.value??"",e.appendChild(a);const s=document.createElement("div");s.className="save-progress",e.appendChild(s),a.addEventListener("input",(t=>{this.value=parseFloat(t.target.value),s.style.transition="none",s.style.width="0",this._timeout&&clearTimeout(this._timeout),requestAnimationFrame((()=>{s.style.transition=`width ${this._delay}ms linear`,s.style.width="100%"})),this._timeout=setTimeout((()=>{this.notifyChange(),s.style.transition="none",s.style.width="0"}),this._delay)})),t.appendChild(e)}}class a extends t{constructor(t,e,i=null,a={},s=null,n="default"){super(t,e,i,a,s,n),this.type="string",this._timeout=null,this._delay=2e3,this._delay=this.options?.delay??2e3,this._placeholder=this.options?.placeholder??""}render(t){const e=super.render();e.classList.add("string");const i=document.createElement("label");i.textContent=this.label,e.appendChild(i);const a=document.createElement("input");a.type="text",a.value=this.value??"",this._placeholder&&(a.placeholder=this._placeholder),e.appendChild(a);const s=document.createElement("div");s.className="save-progress",e.appendChild(s),a.addEventListener("input",(t=>{this.value=t.target.value,s.style.transition="none",s.style.width="0",this._timeout&&clearTimeout(this._timeout),requestAnimationFrame((()=>{s.style.transition=`width ${this._delay}ms linear`,s.style.width="100%"})),this._timeout=setTimeout((()=>{this.notifyChange(),s.style.transition="none",s.style.width="0"}),this._delay)})),t.appendChild(e)}}class s{static accordion(t,e){let i=document.createElement("div");i.className="__accordeon accordeon",e&&i.classList.add(e);let a=document.createElement("div");a.className="__accordeon_title accordeon-title",a.textContent=t,i.appendChild(a);let s=document.createElement("div");return s.className="accordeon-content",i.appendChild(s),{accordeon:i,accordeon_content:s}}static glow_stick(){let t=document.createElement("div");return t.className="glow-bar",t}static input_text(t="",e="",i=""){let a=document.createElement("input");return a.type="text",a.placeholder=t,a.value=e,a.className=i,a}static button_submit(t="Envoyer",e="button button-primary"){let i=document.createElement("button");return i.type="submit",i.className=e,i.textContent=t,i}static button(t="Button",e="button",i=null){let a=document.createElement("div");return a.className=e,a.textContent=t,i&&a.addEventListener("click",i),a}static div(t=""){let e=document.createElement("div");return e.className=t,e}static modal(t="",e=null){let i=this.div("modal"),a=this.div("modal-wrapper"),s=this.div("modal-close"),n=this.div("modal-content");return t&&(this.div("modal-title").textContent=t,i.appendChild("titleElement")),a.appendChild(s),a.appendChild(n),i.appendChild(a),s.addEventListener("click",(()=>{i.classList.remove("active"),e&&e()})),i.addEventListener("click",(t=>{t.target===i&&(i.classList.remove("active"),e&&e())})),{modal:i,content:n,close:s}}static h2(t,e=""){let i=document.createElement("h2");return i.className=e,i.textContent=t,i}static h3(t,e=""){let i=document.createElement("h3");return i.className=e,i.textContent=t,i}static img(t,e="",i=""){let a=document.createElement("img");return a.src=t,a.alt=e,i&&(a.className=i),a}static list(t=[],e=""){let i=document.createElement("ul");return i.className=e,t.forEach((t=>{let e=document.createElement("li");e.innerHTML=t,i.appendChild(e)})),i}static search(t="Rechercher...",e=null,i=null,a=2,s=!1){let n=this.div("search-container"),o=this.input_text(t);o.type="search";let r=this.div("search-results "+(s?" open-bottom":"open-top"));return n.appendChild(o),n.appendChild(r),e&&o.addEventListener("input",(()=>{let t=o.value;t.length>=a?e(t,r):r.innerHTML=""})),i&&r.addEventListener("click",(t=>{let e=t.target.closest(".result-item");e&&i(e)})),n.addEventListener("close",(()=>{r.innerHTML="",o.value=""})),{searchContainer:n,results:r}}static input_search(t="",e="",i=null,a=null,s=2){let n=this.input_text(t,"",e);return n.type="search",n.addEventListener("input",(()=>{let t=n.value;t.length>=s?i(t):a()})),n}}class n{static _domains={};static _loaded={};static async load(t){if(!this._loaded[t]){try{const e=await fetch(`/admin/locale/domain/get/${t}`);if(!e.ok)throw new Error(`Error for domain: ${t}`);const i=await e.json();return this._domains[t]=i,this._loaded[t]=!0,i}catch(t){console.error(`[Translator] ${t.message}`)}return null}}static async translate(t,e="bugquest",i={}){e=e.trim(),t=t.trim(),this._loaded[e]||await this.load(e);let a=this._domains[e]?.[t]??t;return this._applyReplacements(a,i)}static t(t,e="bugquest",i={}){let a=this._domains[e]?.[t]??t;return this._applyReplacements(a,i)}static _applyReplacements(t,e){return t.replace(/{(.*?)}/g,((t,i)=>e[i]??t))}}function o(t,e="bugquest",i={}){return n.t(t,e,i)}class r{static show(t=()=>{},e=()=>{},i={}){const a={title:o("Confirmation","admin"),message:o("Êtes-vous sûr de vouloir continuer ?","admin"),confirmText:o("Valider","admin"),cancelText:o("Annuler","admin"),confirmClass:"button success",cancelClass:"button danger"},{title:n,message:r,confirmText:d,cancelText:l,confirmClass:c,cancelClass:h}={...a,...i},p=s.div("confirm-title");p.textContent=n;const m=s.div("confirm-overlay"),u=s.div("confirm-box"),g=s.div("confirm-message");g.textContent=r;const v=s.div("confirm-actions"),y=s.button(d,c,(()=>{t(),m.remove()})),w=s.button(l,h,(()=>{e(),m.remove()}));v.append(y,w),u.append(p,g,v),m.appendChild(u),document.body.appendChild(m),setTimeout((()=>m.classList.add("active")),10)}}class d{static containers=new Map;static show(t,{type:e="info",position:i="top-right",duration:a=4e3,icon:s=null,closable:n=!0}={}){const o=this._getContainer(i),r=document.createElement("div");r.className=`bq-toast ${e}`,r.innerHTML=`\n            ${s?`<div class="bq-toast-icon">${s}</div>`:""}\n            <div class="bq-toast-message">${t}</div>\n            ${n?'<button class="bq-toast-close" title="Fermer">✖</button>':""}\n        `,n&&r.querySelector(".bq-toast-close").addEventListener("click",(()=>this._removeToast(r))),o.appendChild(r),requestAnimationFrame((()=>{r.classList.add("show")})),a>0&&setTimeout((()=>this._removeToast(r)),a)}static _getContainer(t){if(!this.containers.has(t)){const e=document.createElement("div");e.className=`bq-toast-container ${t}`,document.body.appendChild(e),this.containers.set(t,e)}return this.containers.get(t)}static _removeToast(t){t.classList.remove("show"),setTimeout((()=>t.remove()),300)}}class l{constructor(t){this.gallery=t,this.waitingTags=[],this.deletionMode=!1,this.new_tag="";const{modal:e,content:i,close:a}=s.modal(null,(()=>{this.gallery.loadPage(),this.waitingTags=[],this.deletionMode=!1,i.innerHTML=""}));this.modal=e,this.modal_content=i,document.body.appendChild(this.modal)}async open(t){if(!t)return;this.waitingTags=t.tags?JSON.parse(JSON.stringify(t.tags)):[],this.deletionMode=!1,this.modal_content.innerHTML="";const e=s.div("media-modal");e.appendChild(this.buildActions(t)),e.appendChild(this.buildPreview(t));const i=s.div("media-modal--info"),a=s.div("media-modal--info-container"),n=s.h2(t.original_name),o=s.div(),r=s.list([`<strong>Type :</strong> ${t.mime_type}`,`<strong>Taille :</strong> ${(t.size/1024).toFixed(1)} ko`,`<strong>Extension :</strong> ${t.extension}`,`<strong>Ajouté le :</strong> ${new Date(t.created_at).toLocaleDateString("fr-FR")}`]);if(o.appendChild(n),o.appendChild(r),a.appendChild(o),a.appendChild(this.buildTagEditor(t)),i.appendChild(a),t.exif&&"object"==typeof t.exif&&Object.keys(t.exif).length>0){const{accordeon:e,accordeon_content:a}=s.accordion("EXIF","small"),n=s.list(Object.entries(t.exif).map((([t,e])=>`<strong>${t}:</strong> ${"object"==typeof e?JSON.stringify(e):e}`)));n.classList.add("media-modal--exif"),a.appendChild(n),i.appendChild(e)}e.appendChild(i),this.modal_content.appendChild(e),this.modal.classList.add("active")}buildTagUpdateButton(t){const e=s.div("icon info hidden");return e.innerHTML="💾",e.dataset.tooltip=o("Mettre à jour les tags","admin"),e.dataset.tooltipType="info",e.onclick=async()=>{const e=this.waitingTags.map((t=>t.id)).map((t=>`tags[]=${encodeURIComponent(t)}`)).join("&");this.deletionMode=!1,this.tagDeleteBtn.classList.remove("active");try{const i=await fetch(`${this.gallery.apiUrl}/tags/set/${t.id}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e});if(!i.ok)throw new Error(`HTTP ${i.status}`);this.waitingTags.forEach((t=>{"new"in t&&t.new&&delete t.new})),t.tags=JSON.parse(JSON.stringify(this.waitingTags)),this.updateTagList(),this.updateTagButtonVisibility(),d.show(o("Tags mis à jour","admin"),{type:"success",icon:"✅",duration:2e3,position:"bottom-right",closable:!0})}catch(t){d.show("[MediaModalViewer] "+o("Erreur mise à jour des tags :","admin")+" "+t.message,{type:"danger",icon:"⚠️",duration:5e3,position:"bottom-right",closable:!0}),console.error("[MediaModalViewer] "+o("Erreur mise à jour des tags :","admin"),t)}},e}buildTagDeleteToggle(t){const e=s.div("icon danger");return e.innerHTML="❌",e.dataset.tooltip=o("Mode suppression","admin"),e.dataset.tooltipType="danger",e.onclick=()=>{if(this.deletionMode=!this.deletionMode,!this.deletionMode){const e=this.waitingTags.filter((t=>"new"in t&&t.new));this.waitingTags=t.tags?JSON.parse(JSON.stringify(t.tags)):[],this.waitingTags.push(...e),this.updateTagList(),this.updateTagButtonVisibility()}e.classList.toggle("active",this.deletionMode)},e}buildAddCategoryButton(t){const e=s.div("icon hidden");return e.innerHTML="➕",e.dataset.tooltip=o("Ajouter une nouvelle catégorie","admin"),e.dataset.tooltipType="info",e.onclick=async()=>{if(this.new_tag&&!(this.new_tag.length<3)&&!this.gallery.tags.find((t=>t.name.toLowerCase()===this.new_tag.toLowerCase())))try{const t=await fetch(`${this.gallery.apiUrl}/tags/add`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"name="+encodeURIComponent(this.new_tag)});if(this.search.dispatchEvent(new Event("close")),this.new_tag="",this.tagAddBtn.classList.add("hidden"),!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json();this.gallery.tags.push(e),this.gallery.renderTags(),e.new=!0,this.waitingTags.push(e),this.updateTagList(),this.updateTagButtonVisibility()}catch(t){d.show("[MediaModalViewer] "+o("Erreur d'ajout de tag :","admin")+" "+t.message,{type:"danger",icon:"⚠️",duration:5e3,position:"bottom-right",closable:!0}),console.error("[MediaModalViewer] "+o("Erreur d'ajout de tag :","admin"),t)}},e}buildTagEditor(t){const e=s.div("media-modal--tags"),i=s.div("media-modal--tags-list"),a=s.div("media-modal--tags-actions");this.tagUpdateBtn=this.buildTagUpdateButton(t),this.tagAddBtn=this.buildAddCategoryButton(t),this.tagDeleteBtn=this.buildTagDeleteToggle(t),a.append(this.tagUpdateBtn,this.tagDeleteBtn,this.tagAddBtn),this.updateTagButtonVisibility=()=>{const e=this.waitingTags.map((t=>t.id)),i=t.tags.map((t=>t.id));e.length!==i.length||e.some((t=>!i.includes(t)))?this.tagUpdateBtn.classList.remove("hidden"):this.tagUpdateBtn.classList.add("hidden")},this.updateTagList=()=>{i.innerHTML="",this.waitingTags.forEach((t=>{const e=s.div("tag");e.textContent=t.name,e.dataset.tag=t.id,t.new&&(e.classList.add("new"),e.dataset.tooltip=o("Cliquez pour supprimer","admin"),e.dataset.tooltipType="info"),e.onclick=()=>{this.deletionMode&&(this.waitingTags=this.waitingTags.filter((e=>e.id!==t.id)),e.remove(),this.updateTagButtonVisibility())},i.appendChild(e)}))},this.updateTagList();const{searchContainer:n,result:r}=s.search(o("Ajouter un tag","admin")+"...",((e,i)=>{this.new_tag=e,i.innerHTML="";const a=this.gallery.tags.filter((i=>i.name.toLowerCase().includes(e.toLowerCase())&&!t.tags.some((t=>t.id===i.id))&&!this.waitingTags.some((t=>t.id===i.id))));a.length?(this.tagAddBtn.classList.add("hidden"),i.classList.add("active")):(this.tagAddBtn.classList.remove("hidden"),i.classList.remove("active")),a.forEach((t=>{const e=s.div("result-item");e.textContent=t.name,e.dataset.tag=t.id,i.appendChild(e)}))}),(t=>{const e=parseInt(t.dataset.tag),i=this.gallery.tags.find((t=>t.id===e));i&&(i.new=!0,this.waitingTags.push(i),n.dispatchEvent(new Event("close")),this.updateTagList(),this.updateTagButtonVisibility())}),2);return this.search=n,e.append(a,i,n),e}buildActions(t){const e=s.div("flex-actions"),i=s.div("icon");i.innerHTML="📥",i.dataset.tooltip=o("Télécharger","admin"),i.dataset.tooltipType="info",i.onclick=async()=>{const e=await(await fetch("/"+t.path)).blob(),i=URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=t.original_name,document.body.appendChild(a),a.click(),document.body.removeChild(a)};const a=s.div("icon");a.innerHTML="🔗",a.dataset.tooltip=o("Ouvrir","admin"),a.dataset.tooltipType="info",a.onclick=()=>window.open("/"+t.path,"_blank");const n=s.div("icon danger");return n.innerHTML="🗑️",n.dataset.tooltip=o("Supprimer","admin"),n.dataset.tooltipType="danger",n.onclick=async()=>{r.show((async()=>{try{const e=await fetch(`${this.gallery.apiUrl}/delete/${t.id}`,{method:"DELETE"});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.gallery.loadPage(),d.show(o("Média supprimé","admin"),{type:"success",icon:"✅",duration:2e3,position:"bottom-right",closable:!0}),this.close()}catch(t){d.show("[MediaModalViewer] "+o("Erreur suppression média :","admin")+" "+t.message,{type:"danger",icon:"⚠️",duration:5e3,position:"bottom-right",closable:!0}),console.error("[MediaModalViewer] "+o("Erreur suppression média :","admin"),t)}}),(()=>null),{title:o("Supprimer ce média ?","admin"),message:o("Cette action est irréversible. Êtes-vous sûr de vouloir continuer ?","admin"),confirmText:o("Supprimer","admin"),cancelText:o("Annuler","admin"),confirmClass:"button danger",cancelClass:"button info"})},e.append(i,a,n),e}buildPreview(t){const e=s.div("media-modal--preview");if(t.mime_type.startsWith("image/"))e.appendChild(s.img("/"+t.path,t.original_name));else if(t.mime_type.startsWith("image/svg")){const i=s.img("/"+t.path,t.original_name);e.appendChild(i)}else{const i=s.div("media-card--icon");i.innerHTML=this.gallery.getIconForMime(t.mime_type),e.appendChild(i)}return e}close(){this.modal.classList.remove("active"),this.modal_content.innerHTML=""}}class c{constructor(t){this.element=t,this.canUpload=!1,this.canModal=!1,this.onClickItem=null,this.canEditTags=!1,this.deletionMode=!1,this.perPage=12,this.selectTags=[],this.tags=[],this.mimeTypes=[],this.forced_mimeTypes=[],this.search="";const e=this.element.dataset.perPage;e&&!isNaN(e)&&(this.perPage=parseInt(e,10));const i=this.element.dataset.canUpload;i&&"true"===i&&(this.canUpload=!0);const a=this.element.dataset.canModal;a&&"true"===a&&(this.canModal=!0);const s=this.element.dataset.canEditTags;s&&"true"===s&&(this.canEditTags=!0);const n=this.element.dataset.forcedMimeTypes;n&&n.length>0&&(this.forced_mimeTypes=n.split(",").map((t=>t.trim()))),this.apiUrl="/admin/medias",this.buildElements(),this.initEvents(),this.loadTags(),this.loadPage()}buildElements(){this.canUpload&&(this.dropZone=s.div("media-dropzone"),this.element.appendChild(this.dropZone));const t=s.div("media-gallery-tags");if(this.element.appendChild(t),this.canEditTags){const{accordeon:e,accordeon_content:i}=s.accordion(o("Ajouter des tags","admin"),"small");t.appendChild(e),t.appendChild(s.glow_stick());const a=s.div("media-gallery-tags-form");i.appendChild(a),this.tag_input=s.input_text(o("Ajouter un tag","admin"),"","small full"),a.appendChild(this.tag_input),this.tag_submit=s.button_submit(o("Ajouter","admin"),"button button-primary"),this.tag_submit.addEventListener("click",(t=>{t.preventDefault(),this.deletionMode=!1,tagDeleteBtn.classList.remove("active"),this.search="",this.updateTags();const e=this.tag_input.value.trim();e&&(this.addTag(e),this.tag_input.value="")})),a.appendChild(this.tag_submit)}const e=s.div("media-gallery-tags-actions");t.appendChild(e);const i=s.input_search(o("Rechercher","admin")+"...","small",(t=>{this.search=t,this.updateTags()}),(()=>{this.search="",this.updateTags()}));if(e.appendChild(i),this.canEditTags){const t=this.buildTagDeleteToggle();e.appendChild(t)}this.tags_content=s.div("media-gallery-tags-content"),t.appendChild(this.tags_content);const a=s.div("fullw");this.element.appendChild(a),this.grid=s.div("media-gallery-content"),a.appendChild(this.grid),this.pagination=s.div("media-gallery-pagination"),a.appendChild(this.pagination),this.canModal&&(this.modal=new l(this))}buildTagDeleteToggle(t){const e=s.div("icon danger");return e.innerHTML="❌",e.dataset.tooltip=o("Mode suppression","admin"),e.dataset.tooltipType="danger",e.onclick=()=>{this.deletionMode=!this.deletionMode,this.deletionMode&&(this.selectTags=[],this.updateTags(),this.loadPage()),e.classList.toggle("active",this.deletionMode)},e}initEvents(){this.pagination.addEventListener("click",(t=>{const e=t.target.closest("span[data-page]");if(e){t.preventDefault();const i=parseInt(e.dataset.page,10);isNaN(i)||this.loadPage(i)}})),this.tags_content.addEventListener("click",(t=>{t.preventDefault();const e=t.target.closest("span[data-tag]");if(!e)return;const i=e.dataset.tag;i&&(this.deletionMode?r.show((async()=>{const t=await fetch(`${this.apiUrl}/tags/delete/${i}`,{method:"DELETE",headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);await t.json(),e.remove(),this.loadPage(),d.show(o("Tag supprimé avec succès","admin"),{type:"success",icon:"✅",duration:5e3,position:"bottom-right",closable:!0})}),(()=>null),{title:o("Supprimer ce tag ?","admin"),message:o("Cette action est irréversible. Êtes-vous sûr de vouloir continuer ?","admin"),confirmText:o("Supprimer","admin"),cancelText:o("Annuler","admin"),confirmClass:"button danger",cancelClass:"button info"}):(this.selectTags.includes(i)?this.selectTags.splice(this.selectTags.indexOf(i),1):this.selectTags.push(i),this.updateTags(),this.loadPage(1)))})),this.canUpload&&(this.element.addEventListener("dragover",(t=>{t.preventDefault(),this.dropZone.classList.add("active")})),this.element.addEventListener("dragleave",(t=>{null!==t.relatedTarget&&this.dropZone.contains(t.relatedTarget)||this.dropZone.classList.remove("active")})),this.element.addEventListener("drop",(t=>{t.preventDefault(),this.dropZone.classList.remove("active");const e=[...t.dataTransfer.files];for(let t of e)this.uploadFile(t)}))),this.element.addEventListener("click",(t=>{const e=t.target.closest(".__media_card");if(e)try{const t=JSON.parse(e.dataset.media);"function"==typeof this.onClickItem&&this.onClickItem(t),this.canModal&&this.modal.open(t)}catch(t){return d.show(o("Erreur de parsing du média :","admin")+" "+t.message,{type:"danger",icon:"⚠️",duration:5e3,position:"bottom-right",closable:!0}),void console.error(o("Erreur de parsing du média :","admin"),t)}}))}async loadPage(t=1){try{const e=new URLSearchParams;e.set("per_page",this.perPage),this.selectTags.forEach((t=>{e.append("tags[]",t)})),this.forced_mimeTypes&&this.forced_mimeTypes.forEach((t=>{e.append("mime_types[]",t)}));const i=await fetch(`${this.apiUrl}/all/${t}?${e}`);if(!i.ok)throw new Error(`HTTP ${i.status}`);const a=await i.json();this.renderMedia(a.items),this.renderPagination(a.current_page,a.last_page)}catch(t){d.show("[MediaGalleryLoader] "+o("Erreur de chargement des médias :","admin")+" "+t.message,{type:"danger",icon:"⚠️",duration:5e3,position:"bottom-right",closable:!0}),console.error("[MediaGalleryLoader] "+o("Erreur de chargement des médias :","admin"),t)}}async loadTags(){try{const t=await fetch(`${this.apiUrl}/tags/all`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json();this.tags=e,this.renderTags()}catch(t){d.show("[MediaGalleryLoader] "+o("Erreur de chargement des tags :","admin")+" "+t.message,{type:"danger",icon:"⚠️",duration:5e3,position:"bottom-right",closable:!0}),console.error("[MediaGalleryLoader] "+o("Erreur de chargement des tags :","admin"),t)}}async addTag(t){try{const e=await fetch(`${this.apiUrl}/tags/add`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"name="+encodeURIComponent(t)});if(!e.ok)throw new Error(`HTTP ${e.status}`);await e.json(),this.loadTags()}catch(t){d.show("[MediaGalleryLoader] "+o("Erreur d'ajout de tag :","admin")+" "+t.message,{type:"danger",icon:"⚠️",duration:5e3,position:"bottom-right",closable:!0}),console.error("[MediaGalleryLoader] "+o("Erreur d'ajout de tag :","admin"),t)}}renderMedia(t=[]){this.grid.innerHTML="",t.forEach((t=>{const e=this.createMediaCard(t);this.grid.appendChild(e)}))}renderPagination(t,e){this.pagination.innerHTML="";for(let i=1;i<=e;i++){const e=document.createElement("span");e.dataset.page=i,e.textContent=i,i===t&&e.classList.add("active"),this.pagination.appendChild(e)}}renderTags(){this.tags_content.innerHTML="",this.tags.forEach((t=>{const e=document.createElement("span");e.dataset.tag=t.id,e.textContent=t.name,this.tags_content.appendChild(e)}))}updateTags(){this.tags_content.querySelectorAll("span[data-tag]").forEach((t=>{const e=t.dataset.tag;e&&(this.search&&t.classList.toggle("hidden",!t.textContent.toLowerCase().includes(this.search.toLowerCase())),this.selectTags.includes(e)?t.classList.add("active"):t.classList.remove("active"))}))}createMediaCard(t){const e=document.createElement("div");e.className="media-card __media_card",e.dataset.id=t.id;const i=t.mime_type.startsWith("image/");return e.innerHTML=`\n            <div class="media-card--mime">${t.mime_type}</div>\n            <div class="media-card--preview">\n                ${i?`<img src="/${t.path}" alt="${t.original_name}">`:`<div class="media-card--icon">${this.getIconForMime(t.mime_type)}</div>`}\n            </div>\n            <div class="media-card--meta">\n                <div class="name">${t.original_name}</div>\n                <div class="size">${(t.size/1024).toFixed(1)} ko</div>\n            </div>\n        `,e.dataset.media=JSON.stringify(t),e}replaceCardWithMedia(t,e){const i=this.createMediaCard(e);t.replaceWith(i)}getIconForMime(t){return"application/pdf"===t?"📄":"text/plain"===t?"📃":t.startsWith("video/")?"🎥":"📁"}uploadFile(t){const e=new FormData;e.append("file",t);const i=s.div("media-card uploading"),a=s.div("media-card--preview"),n=s.div("progress-bar");a.appendChild(this.getPreviewHTML(t)),i.appendChild(a),i.appendChild(n),this.grid.prepend(i);const r=i.querySelector(".progress-bar"),d=new XMLHttpRequest;d.open("POST",`${this.apiUrl}/upload`),d.upload.onprogress=t=>{const e=Math.floor(t.loaded/t.total*100);r.style.width=e+"%"},d.onload=()=>{if(200===d.status)try{const t=JSON.parse(d.responseText);this.replaceCardWithMedia(i,t)}catch(t){i.innerHTML=`<div class="error">❌ ${o("Réponse invalide","admin")}</div>`}else i.innerHTML=`<div class="error">❌ ${o("Upload échoué","admin")}</div>`},d.onerror=()=>{i.innerHTML=`<div class="error">❌ ${o("Erreur réseau","admin")}</div>`},d.send(e)}getPreviewHTML(t){if(t.type.startsWith("image/svg"))return s.img(URL.createObjectURL(t),"preview");if(t.type.startsWith("image/"))return s.img(URL.createObjectURL(t),"preview");const e=s.div("media-card--icon");return e.innerHTML=this.getIconForMime(t.type),e}}class h extends t{constructor(t,e,i=null,a={},s=null,n="default"){super(t,e,i,a,s,n),this.type="media",this.mimeTypes=a.mimeTypes||[]}render(t){const e=super.render();e.classList.add("media");const i=document.createElement("div");i.className="media-preview",i.textContent=this.value||"Aucun média sélectionné",i.dataset.tooltip="Sélectionner un média",i.addEventListener("click",(()=>{this.modal.classList.add("active")})),this.value&&(i.appendChild(this.getPreview(this.value)),this.value=this.value.id);const a=document.createElement("label");a.textContent=this.label,e.appendChild(i),e.appendChild(a),t.appendChild(e);const{modal:n,content:o,close:r}=s.modal(null,(()=>{}));o.dataset.canUpload="true",o.dataset.forcedMimeTypes=this.mimeTypes,this.modal=n,document.body.appendChild(this.modal),this.gallery=new c(o),this.gallery.onClickItem=t=>{this.value=t.id,i.appendChild(this.getPreview(t)),this.modal.classList.remove("active"),this.notifyChange()}}getPreview(t){if(t.mime_type.startsWith("image/"))return s.img("/"+t.path,t.name,"media-current");{const e=this.gallery.getIconForMime(t.mime_type);let i=document.createElement("span");return i.className="media-current",i.textContent=e,i}}}class p extends t{constructor(t,e,i=null,a={},s=null,n="default"){super(t,e,i,a,s,n),this.type="string"}render(t){const e=super.render();e.classList.add("select");const i=document.createElement("label");i.textContent=this.label,i.setAttribute("for",this.key);const a=document.createElement("select");a.id=this.key,a.name=this.key,this.options?.options.forEach((t=>{const e=document.createElement("option");e.value=t.value,e.textContent=t.label,e.selected=t.value===this.value,a.appendChild(e)})),a.addEventListener("change",(()=>{this.value=a.value,this.notifyChange()})),e.appendChild(i),e.appendChild(a),t.appendChild(e)}}class m extends t{constructor(t,e,i=!1,a={},s=null,n="default"){super(t,e,i,a,s,n),this.type="bool"}render(t){const e=super.render();e.classList.add("bool");const i=document.createElement("label");i.textContent=this.label,e.appendChild(i);const a=document.createElement("div");a.className="bool-switch",a.dataset.state=this.value?"on":"off",a.title=this.value?"Activé":"Désactivé",a.addEventListener("click",(()=>{this.value=!this.value,a.dataset.state=this.value?"on":"off",a.title=this.value?"Activé":"Désactivé",this.notifyChange()})),e.appendChild(a),t.appendChild(e)}}class u{static types={int:e,float:i,string:a,media:h,select:p,bool:m};static register(t,e){this.types[t]=e}static create(t,e,i,a=null,s=[],n=null,o="default"){const r=this.types[t];if(!r)throw new Error(`Type de bloc inconnu : ${t}`);return new r(e,i,a,s,n,o)}}class g{static _cache=new Map;static async getOption(t,e){if(this._cache.has(t)&&this._cache.get(t).has(e))return this._cache.get(t).get(e);const i=await fetch(`/admin/options/get/${t}/${e}`);if(!i.ok)throw new Error(`Erreur chargement de l'option "${e}"`);const a=await i.json();return this._cache.has(t)||this._cache.set(t,new Map),this._cache.get(t).set(e,a),a}static async getOptions(t){if(this._cache.has(t))return Object.fromEntries(this._cache.get(t));const e=await fetch(`/admin/options/get/${t}`);if(!e.ok)throw new Error(`Erreur chargement des options du groupe "${t}"`);const i=await e.json(),a=new Map(Object.entries(i));return this._cache.set(t,a),i}static async saveOption(t){const e=t.group??null,i=t.key??null,a=t.type??null,s=t.value??null;if(!e||!i||"string"!=typeof a)throw new Error("Paramètres invalides pour saveOption()");const n=`/admin/options/set/${e}/${i}`,o={type:a,value:s},r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!r.ok)throw new Error(`Erreur HTTP ${r.status} : enregistrement de "${i}" échoué`);const d=await r.json();return this._cache.has(e)||this._cache.set(e,new Map),this._cache.get(e).set(i,o),d}static async saveOptions(t,e){if(!Array.isArray(e))throw new Error("Les options doivent être un tableau");const i=e.filter((t=>"object"==typeof t&&"string"==typeof t.type&&"value"in t)),a=await fetch(`/admin/options/set/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok)throw new Error(`Erreur lors de l'enregistrement des options du groupe "${t}"`);const s=await a.json(),n=this._cache.get(t)??new Map;return Object.entries(s).forEach((([t,e])=>{n.set(t,e)})),this._cache.set(t,n),s}static async deleteOption(t,e){const i=await fetch(`/admin/options/delete/${t}/${e}`,{method:"DELETE"});if(!i.ok)throw new Error(`Erreur lors de la suppression de l'option "${e}"`);const a=await i.json();return this._cache.has(t)&&this._cache.get(t).delete(e),a}}class v{constructor(t,e="#options-container"){this.group=t,this.container=document.querySelector(e),this.options={},this.blocks=[]}async init(){try{this.options=await g.getOptions(this.group),this.render()}catch(t){console.error(`[OptionsPage] Erreur chargement "${this.group}":`,t),d.show(o("Erreur lors du chargement des options","admin"),{type:"danger",icon:"❌"})}}render(){throw new Error("La méthode render() doit être implémentée dans la sous-classe")}createBlock(t,e,i,a=null,s={},n=this.group){const o=e in this.options?this.options[e]:a,r=u.create(t,e,i,o,s,(t=>this.handleSaveOption(t)),n);return this.blocks.push(r),r}async handleSaveOption(t){try{await g.saveOption(t),d.show(o("Option enregistrée avec succès","admin"),{type:"success",icon:"✅",duration:4e3,position:"bottom-right",closable:!0})}catch(t){console.error("[OptionsPage] Erreur save option:",t),d.show(o("Erreur lors de l'enregistrement","admin"),{type:"error",icon:"❌",duration:4e3,position:"bottom-right",closable:!0})}}renderBlocks(...t){t.forEach((t=>t.render(this.container)))}}class y extends v{constructor(){super("images")}render(){let t=[];try{t=JSON.parse(this.container.dataset.compressionMethods)}catch(t){console.error("Error parsing compression methods:",t)}const e=s.div("options-wrapper"),i=this.createBlock("select","compression_method",o("Méthode de compression","admin"),null,{description:o("Méthode de compression des images","admin"),options:t}),a=this.createBlock("media","placeholder",o("Image de remplacement","admin"),null,{description:o("Image de remplacement pour les images manquantes","admin"),mimeTypes:["image/jpeg","image/png"]});i.render(e),a.render(e),this.container.appendChild(e)}}document.addEventListener("DOMContentLoaded",(async()=>{const t=new y;await t.init()}))})();
//# sourceMappingURL=admin-options-images.js.map